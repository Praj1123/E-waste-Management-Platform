<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <title>Details</title>
    <style>
        .navbar {
            background-color: #28a745;
        }
    </style>
</head>

<body>
    <nav class="navbar sticky-top">
        <div class="container-fluid">
            <img src="/static/images/pick-up.gif" width="100" height="50">
            <form class="d-flex" role="search">
                <p style="padding-right: 10px;font-weight: bold;margin-top:2px;color:white">Hello, Prajwal</p>
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                    class="bi bi-person-circle" viewBox="0 0 16 16">
                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
                    <path fill-rule="evenodd"
                        d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1" />
                </svg>
            </form>
        </div>
    </nav>


    <div class="container mt-5">
        <div class="row">
            <div class="col-sm-6">
                <h3 style="color: #067451;">
                    <div class="card mb-3 shadow-lg">
                        <div class="card-header bg-success text-white text-center">
                            <strong>Product Details</strong>
                        </div>
                        <div class="card-body" style="font-size: large;">
                            <img class="mb-3" src="/static/images/company1.jpeg" id="user_product_image" width="300px"
                                height="auto"
                                style="display: block; margin: 0 auto; border-radius: 10px; box-shadow: 0px 4px 8px rgba(0,0,0,0.1);">
                            <!-- User Details Card -->
                            <div class="card mb-3 shadow-sm" id="user_details">
                                <p class="text-danger mt-5 mb-5" style="display: block;margin:0 auto"><b>Loading...</b>
                                </p>
                                <!--user details will fetch here -->
                            </div>
                            <!-- Product Details Card -->
                            <div class="card shadow-sm" id="product_details">
                                <!--product details will fetch here-->
                            </div>

                            <button type="button" class="btn btn-outline-warning me-2 m-3" id="cancel_pick_up">Cancel
                                Pick-up</button>
                        </div>
                    </div>
                </h3>
            </div>

            <div class="col-sm-6">
                <h3 style="color: #067451;">
                    <div class="card mb-3 shadow-lg">
                        <div class="card-header bg-success text-white text-center">
                            <strong>Verify Product</strong>
                        </div>
                        <div class="card-body" style="font-size: large;">
                            <!-- Image Preview -->
                            <img class="mb-3" src="/static/images/upload.png" id="image_preview" width="300px"
                                height="auto"
                                style="display: block; margin: 0 auto; border-radius: 10px; box-shadow: 0px 4px 8px rgba(0,0,0,0.1);">

                            <!-- File Input for Image Upload -->
                            <div class="input-group mb-3">
                                <input type="file" class="form-control" onchange="set_preview()" id="input_image">
                            </div>

                            <!-- Product Details Section -->
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-secondary text-white">
                                    <strong>Product Details</strong>
                                </div>
                                <div class="card-body">
                                    <img src="/static/images/loading.gif"
                                        style="display: none; margin: 0 auto; border-radius: 10px;" width="200px"
                                        height="200px" id="sp_product_image">

                                    <!-- Brand Selection -->
                                    <p class="mt-3 mb-1 font-semibold">Select Brand</p>
                                    <select class="form-select form-select-lg mb-3" id="sp_brand"
                                        aria-label="Large select example">
                                        <!-- fetching -->
                                    </select>

                                    <!-- Category Selection -->
                                    <p class="mt-3 mb-1 font-semibold">Select Category</p>
                                    <select class="form-select form-select-lg mb-3" id="sp_category"
                                        aria-label="Large select example">
                                        <!-- fetching -->
                                    </select>

                                    <!-- Product Name Selection -->
                                    <p class="mt-3 mb-1 font-semibold">Select Product Name</p>
                                    <select class="form-select form-select-lg mb-3" id="sp_product_name"
                                        aria-label="Large select example">
                                        <!-- fetching -->
                                    </select>

                                    <!-- Product Model Selection -->
                                    <p class="mt-3 mb-1 font-semibold">Select Product Model</p>
                                    <select class="form-select form-select-lg mb-3" id="sp_product_model"
                                        aria-label="Large select example">
                                        <!-- fetching -->
                                    </select>

                                    <!-- Product Specifications -->
                                    <div class="mb-3">
                                        <p class="mt-3 mb-1 font-semibold">Product Specifications</p>
                                        <textarea class="form-control" style="border: none;"
                                            placeholder="Product Specification" id="sp_product_specification" required
                                            readonly></textarea>
                                    </div>

                                    <!-- Base Price Section -->
                                    <div class="mb-3" id="sp_base_price_div">
                                        <p class="mt-3 mb-1 font-semibold">Product Base Price</p>
                                        <p class="ml-5 text-success">Get up to
                                            <span class="text-success font-bold" style="font-size: x-large;"
                                                id="sp_base_price">---</span> Rs
                                        </p>
                                    </div>

                                    <!-- Acceptance Criteria -->
                                    <div>
                                        <p class="mt-3 mb-1 font-semibold">Check Product Acceptance Criteria</p>
                                        <div id="acceptance_criteria_div"
                                            class="border-2 rounded-md border-success border-l-8 p-2">
                                            <span class="text-success font-bold" style="font-size: x-large;">---</span>
                                            <!-- fetching here -->
                                        </div>
                                    </div>

                                    <!-- Best Price Offer -->
                                    <p class="text-success mt-3">Final Price Offered
                                        <b style="font-size: x-large;" id="best_price">---</b> Rs
                                    </p>

                                    <!-- Quantity and Weight Section -->
                                    <p class="mt-3 mb-1 font-semibold">Quantity and Weight of Item</p>
                                    <form class="row g-3 needs-validation m-3" novalidate>
                                        <div class="col-md-6">
                                            <label for="validationCustom01" class="form-label">Quantity</label>
                                            <input type="number" class="form-control" id="quantity" required>
                                            <div class="valid-feedback">Looks good!</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="validationCustom02" class="form-label">Approx. Weight
                                                (kg)</label>
                                            <input type="text" class="form-control" id="weight" required>
                                            <div class="valid-feedback">Looks good!</div>
                                        </div>
                                    </form>

                                    <!-- Modal Footer with Buttons -->
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-danger" style="margin-right: 10px;"
                                            data-bs-dismiss="modal" id="cancel">Cancel</button>
                                        <button type="button" class="btn btn-outline-success" id="get_price">Get
                                            Price</button>
                                        <button type="button" class="btn btn-outline-success" id="continue"
                                            style="display: none;" data-bs-toggle="modal" data-bs-target="#exampleModal"
                                            data-bs-whatever="@mdo">Continue</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <!-- Modal Header -->
                                <div class="modal-header bg-light">
                                    <h2 class="modal-title fs-4" id="exampleModalLabel">Price Confirmation</h2>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>

                                <!-- Modal Body -->
                                <div class="modal-body p-4">
                                    <form>
                                        <div class="mb-4">
                                            <label for="final_price" class="col-form-label fw-bold"
                                                style="font-size: large;">Final Price to be
                                                Offered:</label>
                                            <input type="text" class="form-control border border-2" id="final_price"
                                                disabled>
                                        </div>
                                    </form>
                                </div>

                                <!-- Modal Footer -->
                                <div class="modal-footer d-flex justify-content-between align-items-center">
                                    <p class="text-danger mb-0" style="font-size: small;">
                                        <small>Note: Ensure the customer agrees with the price. If not, you may cancel
                                            the pick-up.</small>
                                    </p>
                                    <div>
                                        <button type="button" class="btn btn-secondary me-2"
                                            data-bs-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-success" id="confirm">Confirm
                                            Pick-up</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </h3>
            </div>
        </div>
    </div>
    <script src="jquery-3.7.1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>

        getCriteria()
        function getCriteria() {
            $.ajax({
                type: 'POST',
                url: "{{url_for('get_criteria')}}",
                success: function (response) {
                    if (response.status == 'success') {
                        data = JSON.parse(response.data)
                        document.getElementById('sp_brand').innerHTML = ''
                        document.getElementById('sp_brand').innerHTML += '<option selected value="none">Choose</option>'
                        for (var i = 0; i < data.length; i++) {
                            temp_data = data[i]
                            document.getElementById('sp_brand').innerHTML += `<option value="${temp_data['organization_name']}">${temp_data['organization_name']}</option>`
                        }
                    } else {
                        if (response.status == 'error') {
                            console.log(response.message)
                        } else {
                            alert('Something went wrong')
                        }
                    }
                },
                error: function (error) {
                    alert('We encounter some technical issue')
                    console.log(error)
                }
            })
        }

        document.getElementById('sp_brand').addEventListener('change', () => {
            var brand = document.getElementById('sp_brand').value
            $.ajax({
                type: 'POST',
                url: "{{url_for('get_criteria1')}}",
                data: { "brand": brand },
                success: function (response) {
                    if (response.status == 'success') {
                        data = JSON.parse(response.data)
                        data = data['listed_product']
                        console.log(data)
                        document.getElementById('sp_category').innerHTML = ''
                        document.getElementById('sp_category').innerHTML += `<option selected value="none">Choose</option>`
                        var array = new Array()
                        for (key in data) {
                            value = data[key]
                            if (array.includes(value['product_category'])) {
                                continue
                            } else {
                                array.push(value['product_category'])
                            }
                        }
                        for (var i = 0; i < array.length; i++) {
                            document.getElementById('sp_category').innerHTML += `<option value="${array[i]}">${array[i]}</option>`
                        }
                    } else {
                        if (response.status == 'error') {
                            console.log(response.message)
                        } else {
                            alert('Something went wrong')
                        }
                    }
                },
                error: function (error) {
                    alert('We encounter some technical issue')
                    console.log(error)
                }
            })

        })

        document.getElementById('sp_category').addEventListener('change', () => {
            var category = document.getElementById('sp_category').value
            var brand = document.getElementById('sp_brand').value
            $.ajax({
                type: 'POST',
                url: "{{url_for('get_criteria1')}}",
                data: { "brand": brand },
                success: function (response) {
                    if (response.status == 'success') {
                        data = JSON.parse(response.data)
                        data = data['listed_product']
                        document.getElementById('sp_product_name').innerHTML = ''
                        document.getElementById('sp_product_name').innerHTML += `<option selected value="none">Choose</option>`
                        var array = new Array()
                        for (key in data) {
                            value = data[key]
                            if (array.includes(value['product_name'])) {
                                continue
                            } else {
                                array.push(value['product_name'])
                            }
                        }
                        for (var i = 0; i < array.length; i++) {
                            document.getElementById('sp_product_name').innerHTML += `<option value="${array[i]}">${array[i]}</option>`
                        }
                    } else {
                        if (response.status == 'error') {
                            console.log(response.message)
                        } else {
                            alert('Something went wrong')
                        }
                    }
                },
                error: function (error) {
                    alert('We encounter some technical issue')
                    console.log(error)
                }
            })

        })

        document.getElementById('sp_product_name').addEventListener('change', () => {
            var brand = document.getElementById('sp_brand').value
            var product_name = document.getElementById('sp_product_name').value
            $.ajax({
                type: 'POST',
                url: "{{url_for('get_criteria1')}}",
                data: { "brand": brand },
                success: function (response) {
                    if (response.status == 'success') {
                        data = JSON.parse(response.data)
                        data = data['listed_product']
                        document.getElementById('sp_product_model').innerHTML = ''
                        document.getElementById('sp_product_model').innerHTML += `<option selected value="none">Choose</option>`
                        var array = new Array()
                        for (key in data) {
                            value = data[key]
                            if (array.includes(value['product_model'])) {
                                continue
                            } else {
                                array.push(value['product_model'])
                            }
                        }
                        for (var i = 0; i < array.length; i++) {
                            document.getElementById('sp_product_model').innerHTML += `<option value="${array[i]}">${array[i]}</option>`
                        }
                    } else {
                        if (response.status == 'error') {
                            console.log(response.message)
                        } else {
                            alert('Something went wrong')
                        }
                    }
                },
                error: function (error) {
                    alert('We encounter some technical issue')
                    console.log(error)
                }
            })

        })

        document.getElementById('cancel').addEventListener('click', () => {
            disableAllInputs(false);
            document.getElementById('get_price').style.display = 'inline-block';
            document.getElementById('continue').style.display = 'none';
        })

        document.getElementById('sp_product_model').addEventListener('click', () => {
            var brand = document.getElementById('sp_brand').value
            var product_model = document.getElementById('sp_product_model').value
            document.getElementById('sp_product_image').style.display = 'block'
            document.getElementById('sp_base_price_div').style.display = 'block'
            $.ajax({
                type: 'POST',
                url: "{{url_for('get_criteria1')}}",
                data: { "brand": brand },
                success: function (response) {
                    if (response.status == 'success') {
                        data = JSON.parse(response.data)
                        data = data['listed_product']
                        for (key in data) {
                            value = data[key]
                            if (product_model == value['product_model']) {
                                document.getElementById('sp_product_specification').value = value['product_specification']
                                console.log(value['product_url'])
                                document.getElementById('sp_product_image').setAttribute('src', value['product_url'])
                                sessionStorage.setItem('base_price', value['product_baseprice'])
                                document.getElementById('sp_base_price').innerHTML = value['product_baseprice']
                                var deducations_array = JSON.parse(value['deductions'])
                                for (var i = 0; i < deducations_array.length; i++) {
                                    data = deducations_array[i]
                                    document.getElementById('acceptance_criteria_div').innerHTML = '';
                                    document.getElementById('acceptance_criteria_div').innerHTML += `
                      <div class="form-check form-check-inline m-2">
                    <input class="form-check-input checkbox" type="checkbox" name="${data['value']}" id="${data['unit']}"
                      value="option1">
                    <label class="form-check-label" for="inlineRadio1">${data['key']}</label>
                  </div>`

                                    if (data['unit'] == 'Per Unit') {
                                        document.getElementById('acceptance_criteria_div').innerHTML += ` 
                    <div class='m-2' style="display: inline-block" id="scratch_input_field">
                    <input type="text" class="form-control" id="${data['value']}" placeholder="Number of ${data['key']}">
                  </div>`
                                    }
                                    document.getElementById('acceptance_criteria_div').innerHTML += ` 
                  <div class="form-check form-check-inline m-2">
                    <input class="form-check-input" type="checkbox" name="inlineRadioOptions" id="inlineRadio2"
                      value="option2">
                    <label class="form-check-label" for="inlineRadio2">No such issue exists</label>
                  </div>
                  <br/>`
                                }

                            } else {
                                continue
                            }
                        }
                    } else {
                        if (response.status == 'error') {
                            console.log(response.message)
                        } else {
                            alert('Something went wrong')
                        }
                    }
                },
                error: function (error) {
                    alert('We encounter some technical issue')
                    console.log(error)
                }
            })

        })

        document.getElementById('get_price').addEventListener('click', () => {
            var brand = document.getElementById('sp_brand').value
            var category = document.getElementById('sp_category').value
            var model_name = document.getElementById('sp_product_model').value
            var product_name = document.getElementById('sp_product_name').value
            var product_baseprice = sessionStorage.getItem('base_price')
            var weight = document.getElementById('weight').value
            var qualtity = document.getElementById('quantity').value
            var input_image = document.getElementById('input_image').files[0]
            if (weight == '') {
                alert('Approx weight of your product required')
            } else {
                if (qualtity == "") {
                    alert('Quantity of your product required')
                } else {
                    if (input_image == 'undefined' || input_image == 'null' || !input_image) {
                        alert('Image of your product required')
                    } else {
                        var checkbox = document.getElementsByClassName('checkbox')
                        var new_value = 0
                        for (var i = 0; i < checkbox.length; i++) {
                            if (checkbox[i].checked) {
                                var check_box_name = checkbox[i].name ///10
                                console.log(check_box_name)
                                if (checkbox[i].id == 'Per Unit') {
                                    var input_value = document.getElementById(check_box_name).value
                                    console.log(input_value)
                                    new_value = parseFloat(new_value) + parseFloat(input_value * check_box_name)
                                } else {
                                    new_value = parseFloat(new_value) + parseFloat(check_box_name)
                                }
                            }
                        }
                        disableAllInputs(true);
                        document.getElementById('best_price').innerHTML = product_baseprice - new_value
                        sessionStorage.setItem('brand', brand)
                        sessionStorage.setItem('category', category)
                        sessionStorage.setItem('model_name', model_name)
                        sessionStorage.setItem('product_name', product_name)
                        sessionStorage.setItem('product_baseprice', product_baseprice)
                        sessionStorage.setItem('weight', weight)
                        sessionStorage.setItem('qualtity', qualtity)
                        sessionStorage.setItem('deduce_amount', product_baseprice - new_value)
                        document.getElementById('final_price').value = product_baseprice - new_value;
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const base64Image = event.target.result;
                            sessionStorage.setItem('product_image', base64Image);
                            document.getElementById('image_preview').src = base64Image;
                        };
                        reader.readAsDataURL(input_image);
                        document.getElementById('continue').style.display = 'inline-block'
                        document.getElementById('get_price').style.display = 'none'
                    }
                }
            }
        })

        function set_preview() {
            var input_image = document.getElementById('input_image').files[0]
            const reader = new FileReader();
            reader.onload = (event) => {
                const base64Image = event.target.result;
                document.getElementById('image_preview').src = base64Image;
            };
            reader.readAsDataURL(input_image);
        }

        function disableAllInputs(value) {
            const inputs = document.querySelectorAll('input, select,textarea');
            inputs.forEach(function (input) {
                input.disabled = value;
            });
        }

        function collect_revised_data() {
            let currentDate = new Date();
            let day = currentDate.getDate();
            let month = currentDate.getMonth() + 1;
            let year = currentDate.getFullYear();
            let formattedDate = day + "/" + month + "/" + year;
            var object = {
                qualtity: sessionStorage.getItem('qualtity'),
                product_name: sessionStorage.getItem('product_name'),
                product_baseprice: sessionStorage.getItem('product_baseprice'),
                model_name: sessionStorage.getItem('model_name'),
                category: sessionStorage.getItem('category'),
                weight: sessionStorage.getItem('weight'),
                deduce_amount: sessionStorage.getItem('deduce_amount'),
                brand: sessionStorage.getItem('brand'),
                picked_up_date: formattedDate,
                product_image: sessionStorage.getItem('product_image'),
            }
            return object
        }

        get_pick_up_details()
        function get_pick_up_details() {
            var request_id = sessionStorage.getItem('request_id')
            var cc_id = localStorage.getItem('cc_id')
            $.ajax({
                type: 'POST',
                url: "{{url_for('get_pick_up_details')}}",
                data: { 'cc_id': cc_id, 'request_id': request_id },
                success: function (response) {
                    if (response.status == 'success') {
                        var data = JSON.parse(response.data)
                        document.getElementById('user_product_image').setAttribute('src', data['product_image'])
                        document.getElementById('user_details').innerHTML = `
                        <div class="card-header bg-secondary text-white">User Details</div>
                                <div class="card-body">
                                    <p><strong>Name:</strong> ${data['firstName']} ${data['lastName']}</p>
                                    <p><strong>Address:</strong> ${data['address']}, ${data['city']}, ${data['state']},${data['zip']}</p>
                                    <p><strong>Mobile No.:</strong> ${data['mobile_number']}</p>
                        </div>
                        `
                        document.getElementById('product_details').innerHTML = `
                        <div class="card-header bg-secondary text-white">Product Details</div>
                                <div class="card-body">
                                    <p><strong>Company:</strong> ${data['brand']}</p>
                                    <p><strong>Category:</strong> ${data['category']}</p>
                                    <p><strong>Product Name:</strong> ${data['product_name']}</p>
                                    <p><strong>Product Model:</strong> ${data['model_name']}</p>
                                    <p><strong>Approx. Weight:</strong> ${data['weight']} kg</p>
                                    <p><strong>Quantity:</strong> ${data['qualtity']} units</p>
                                    <p><strong>Base Price:</strong> ${data['product_baseprice']} Rs</p>
                                    <p><strong>Price Offered:</strong> ${data['deduce_amount']} Rs</p>
                                </div>
                        `

                    } else {
                        if (response.status == 'error') {
                            console.log(response.message)
                        } else {
                            alert('Something went wrong')
                        }
                    }
                },
                error: function (e) {

                }
            })
        }
        document.getElementById('confirm').addEventListener('click', () => {
            if (confirm('Do you really want to confirm Pick-up')) {
                var object = collect_revised_data()
                object['cc_id'] = localStorage.getItem('cc_id')
                object['request_id'] = sessionStorage.getItem('request_id')
                object['status'] = 'Received'

                $.ajax({
                    type: 'POST',
                    url: "{{url_for('pp_confirm_pick_up')}}",
                    data: object,
                    success: function (response) {
                        if (response.status == 'success') {
                            alert('Pick-up confirmed successfully')
                            window.location.href = "{{url_for('pick_up_home')}}"
                        } else {
                            if (response.status == 'error') {
                                alert('Already Picked-up')
                            } else {
                                alert('Something went wrong')
                            }
                        }
                    },
                    error: function (error) {
                        alert('We encounter some technical issue')
                        console.log(error)
                    }
                })
            }
        })

        document.getElementById('cancel_pick_up').addEventListener('click', () => {
            if (confirm('Do you really want to cancel pick-up')) {
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('pp_confirm_pick_up')}}",
                    data: { 'cc_id': localStorage.getItem('cc_id'), 'request_id': sessionStorage.getItem('request_id'), 'status': 'Cancelled' },
                    success: function (response) {
                        if (response.status == 'success') {
                            alert('Pick-up cancelled successfully')
                            window.location.href = "{{url_for('pick_up_home')}}"
                        } else {
                            if (response.status == 'error') {
                                alert('Already Cancelled')
                            } else {
                                alert('Something went wrong')
                            }
                        }
                    },
                    error: function (error) {
                        alert('We encounter some technical issue')
                        console.log(error)
                    }
                })
            }
        })

    </script>
</body>

</html>